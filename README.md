- [Nutanix GitOps Examples](#nutanix-gitops-examples)
  - [Directory Structure](#directory-structure)
  - [Getting Started](#getting-started)
    - [Using Devbox NIX Shell](#using-devbox-nix-shell)
    - [NIX Packages Installed](#nix-packages-installed)
  - [Appendix](#appendix)
    - [Glossary](#glossary)
      - [Infrastructure Specific](#infrastructure-specific)
      - [Platform Specific](#platform-specific)
      - [Application Specific](#application-specific)

# Nutanix GitOps Examples

## Directory Structure

```bash
.
├── configs # Directory for env configs used by local scripts
│   ├── _common
│   │   └── .env # Global env configs 
│   └── ...
├── scripts # Common path for local scripts
├── clusters
│   ├── _profiles # Directory for the varying different profiles
│   │   ├── _base # Base for all cluster profiles (things installed in all variants)
│   │       └── kustomization.yaml # Kustomize ref to one or many platform _base/<service> and _components/feature
│   │   ├── llm-management # Management cluster profile (defines management specific applications and platform variants)
│   │   └── llm-workloads # Workloads cluster profile (defines workload specific applications and platform variants)
│   ├── nke-management-cluster # An example cluster instance generated from `_templates/management-cluster`
│   │   ├── flux-system # Generated by flux bootstrap
│   │   └── platform # generated from _templates
│   │       ├── kustomization.yaml # Maps to `management` profile above and injects secrets/config in the cluster
│   │       ├── cluster-secrets.sops.yaml
│   │       └── cluster-configs.yaml
│   └── nke-workload-cluster-00 # An example cluster instance generated from `_templates/[prod|non-prod]-workload-cluster`
└── platform # Contains catalogue of all the platform services
    ├── cert-manager
    ├── ingress-nginx # Example service
    │   ├── _base # Base implementation of this service     
    │       ├── kustomization.yaml # Kustomize ref to ingress-nginx.yaml
    │       └── ingress-nginx.yaml # helm chart release details for ingress-nginx
    │   └── nodeport # Feature to expose nginx in a NodePort instead of in a LoadBalancer
    │       ├── kustomization.yaml # Component ref to _base and ingress-nginx-patch
    │       └── ingress-nginx-patch.yaml # patch that overrides ingress-nginx helm chart
    └── ...
```

## Getting Started

### Using Devbox NIX Shell

This project uses [devbox](https://github.com/jetpack-io/devbox) to manage its development environment.

Install `devbox` and accept all defaults:

```sh
curl -fsSL https://get.jetpack.io/devbox | bash
```

Start the `devbox shell` and if `nix` isn't available, you will be prompted to install:

```sh
devbox shell
```

### NIX Packages Installed

- [jq@1.7.1](https://www.nixhub.io/packages/jq)
- [gum@0.13.0](https://www.nixhub.io/packages/gum)
- [gh@2.46.0](https://www.nixhub.io/packages/gh)
- [kubectl@1.29.3](https://www.nixhub.io/packages/kubectl)
- [git@2.44.0](https://www.nixhub.io/packages/git)
- [envsubst@1.4.2](https://www.nixhub.io/packages/envsubst)
- [age@1.1.1](https://www.nixhub.io/packages/age)
- [ipcalc@1.0.3](https://www.nixhub.io/packages/ipcalc)
- [arkade@0.11.6](https://www.nixhub.io/packages/arkade)
- [yq-go@4.43.1](https://www.nixhub.io/packages/yq-go)
- [sops@3.8.1](https://www.nixhub.io/packages/sops)
- [kubernetes-helm@3.14.3](https://www.nixhub.io/packages/kubernetes-helm)
- [go-task@3.35.1](https://www.nixhub.io/packages/go-task)

## Appendix

### Glossary

#### Infrastructure Specific

- `Cluster`: Leveraged to install a variant of the infrastructure (ie., A set of Kubernetes nodes that run containerized applications) and a set of tenants with their apps.
- `Operator`: Engineer(s) that manage and own the cluster and platform running in it.
- `Profiles`: 

#### Platform Specific

- `Platform`: A set of apps and configs installed in all clusters, and that allow operators to manage the cluster or provide features to the apps. It provides some pre-set variants that clusters can reuse.
- `Platform service`: A single service of the platform. Examples: ingress-nginx,cert-manager,kube-vip,kafka,milvus

#### Application Specific



- `App`: A single application deployment that integrates and leverages the underlying dependent platform and cluster components. It usually runs in its own namespace and is not a direct dependency on any other application.
- `Tenant`: Are commonly the engineer(s) that manage and own one or many applications.
- `Apps` Are commonly installed by `tenants` (ie., developer teams) into a specific cluster.


- `Base`: Common resources and configurations of any installation of a unit (be it an App, Cluster, Platform Service, etc.)
- `Variants`: Also known as `Component` within the `kustomize` project, are an extension of `base` with extra features. Example: ingress-nginx + kube-vip-loadbalancer.